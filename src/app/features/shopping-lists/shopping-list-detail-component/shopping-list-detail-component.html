<app-header-component></app-header-component>

<div class="shopping-list-detail">
  <div class="detail-header">
    <button class="btn-back" (click)="goBack()">‚Üê Back to Lists</button>
  </div>

  @if (successMessage()) {
  <div class="success-banner">{{ successMessage() }}</div>
  } @if (errorMessage()) {
  <div class="error-banner">{{ errorMessage() }}</div>
  } @if (isLoading()) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>
  } @else if (shoppingList()) {
  <div class="list-content">
    <div class="list-header">
      @if (!isEditingTitle()) {
      <div class="title-section">
        <h2>{{ shoppingList()!.title }}</h2>
        <button class="btn-icon" (click)="enableEditTitle()" aria-label="Edit title">‚úèÔ∏è</button>
      </div>
      } @else {
      <div class="title-edit-section">
        <input type="text" [formControl]="editTitleControl" class="title-input" placeholder="Enter list title" />
        <div class="edit-actions">
          <button class="btn-icon-save" (click)="saveTitle()">‚úì</button>
          <button class="btn-icon-cancel" (click)="cancelEditTitle()">‚úï</button>
        </div>
      </div>
      } @if (shoppingList()!.description) {
      <p class="list-description">{{ shoppingList()!.description }}</p>
      }

      <div class="list-stats">
        <div class="stat">
          <span class="stat-label">Total Items:</span>
          <span class="stat-value">{{ items().length }}</span>
        </div>
        <div class="stat total">
          <span class="stat-label">Total:</span>
          <span class="stat-value total-price">{{ totalPrice() | number: '1.2-2' }} z≈Ç</span>
        </div>
      </div>
    </div>

    <div class="list-actions-bar">
      <button class="btn-primary btn-add-product" (click)="toggleAddProduct()">
        @if (showAddProduct()) {
        <span>Cancel</span>
        } @else {
        <span>+ Add Product</span>
        }
      </button>
      <button class="btn-secondary btn-shop-mode" (click)="goToShopMode()">üõí Shop Mode</button>
    </div>

    @if (showAddProduct()) {
    <div class="add-product-section">
      <h3>Add Product to List</h3>

      <form [formGroup]="addProductForm" (ngSubmit)="onAddProduct()">
        <!-- Step 1: Category Selection -->
        <div class="form-group">
          <label for="categoryFilter">1. Select Category *</label>
          <select id="categoryFilter" [formControl]="categoryFilterControl" class="category-select">
            <option [value]="null">-- Choose a category first --</option>
            @for (category of categories(); track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
            }
          </select>
          <p class="helper-text">Select a category to load products</p>
        </div>

        <!-- Step 2: Product Search & Selection (Only shows after category selected) -->
        @if (categoryFilterControl.value) {
        <div class="product-search">
          <label for="productSearch">2. Search Products (Optional)</label>
          <input
            id="productSearch"
            type="text"
            [formControl]="productSearchControl"
            placeholder="Search products in this category..."
            class="search-input"
          />
        </div>

        <!-- Step 3: Product Selection -->
        <div class="form-group">
          <label for="product">3. Select Product *</label>
          @if (isLoadingProducts()) {
          <div class="loading-products">
            <div class="small-spinner"></div>
            <span>Loading products...</span>
          </div>
          }
          <select id="product" formControlName="productId" class="product-select" [disabled]="isLoadingProducts()">
            <option [value]="null">-- Choose a product --</option>
            @for (product of filteredProducts(); track product.id) {
            <option [value]="product.id">
              {{ product.name }} - {{ product.price | number: '1.2-2' }} z≈Ç/{{ product.unit }}
            </option>
            }
          </select>
          @if (filteredProducts().length === 0 && !isLoadingProducts()) {
          <p class="info-text">No products found in this category</p>
          }
        </div>

        <!-- Step 4: Quantity -->
        <div class="form-group">
          <label for="quantity">4. Quantity *</label>
          <input id="quantity" type="number" formControlName="quantity" min="1" class="quantity-input" />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="addProductForm.invalid || isLoadingProducts()">
            Add to List
          </button>
          <button type="button" class="btn-secondary" (click)="toggleAddProduct()">Cancel</button>
        </div>
        }
      </form>
    </div>
    } @if (items().length === 0) {
    <div class="empty-state">
      <p>No items in this list yet.</p>
      <button class="btn-primary" (click)="toggleAddProduct()">Add Your First Product</button>
    </div>
    } @else {
    <div class="items-list">
      @for (item of items(); track item.listItemId) {
      <div class="item-card" [class.checked]="item.isChecked">
        <div class="item-details">
          <h4 class="item-name">{{ item.productName }}</h4>
          <div class="item-meta">
            <span class="item-price">{{ item.priceAtAddition | number: '1.2-2' }} z≈Ç / {{ item.unit }}</span>
            <span class="item-date">Added {{ item.addedAt | date: 'MMM d, y' }}</span>
          </div>
        </div>

        <div class="item-quantity">
          <button
            class="qty-btn"
            (click)="onUpdateQuantity(item.listItemId, item.quantity - 1)"
            [disabled]="item.quantity <= 1"
          >
            -
          </button>
          <span class="qty-value">{{ item.quantity }}</span>
          <button class="qty-btn" (click)="onUpdateQuantity(item.listItemId, item.quantity + 1)">+</button>
        </div>

        <div class="item-total">
          <span class="total-label">Total:</span>
          <span class="total-value">{{ (item.quantity * item.priceAtAddition) | number: '1.2-2' }} z≈Ç</span>
        </div>

        <button class="btn-remove" (click)="onRemoveItem(item.listItemId)" aria-label="Remove item">delete</button>
      </div>
      }
    </div>
    }
  </div>
  }
</div>
<app-footer></app-footer>
